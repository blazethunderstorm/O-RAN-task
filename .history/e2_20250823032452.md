# Near-RT RIC Platform Deployment Guide

## Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [E2 Simulator Setup](#e2-simulator-setup)
4. [Near-RT RIC Platform Deployment](#near-rt-ric-platform-deployment)
5. [Docker Image Build](#docker-image-build)
6. [Kubernetes Deployment](#kubernetes-deployment)
7. [Helm Deployment](#helm-deployment)
8. [Troubleshooting](#troubleshooting)
9. [Final Status and Verification](#final-status-and-verification)
10. [API Testing](#api-testing)
11. [Resources and References](#resources-and-references)

## Overview

This document provides a comprehensive guide for deploying the Near-RT RIC platform with E2 simulator integration. The deployment includes various components such as SubMgr, E2Term, and xApps, following the official O-RAN SC documentation.

## Prerequisites

### System Requirements
- Ubuntu 20.04 or later
- Docker installed
- Kubernetes cluster (kind/minikube recommended for development)
- Helm 3.x installed

### Install Dependencies
```bash
sudo apt-get update
sudo apt-get install -y build-essential cmake libsctp-dev lksctp-tools autoconf automake libtool bison flex libboost-all-dev
sudo apt-get install -y libprotobuf-c-dev libcurl4-openssl-dev
```

## E2 Simulator Setup

### 1. Clone Required Repositories

```bash
# Clone RIC deployment repository
git clone "https://gerrit.o-ran-sc.org/r/ric-plt/ric-dep"

# Clone E2 interface simulator
git clone "https://gerrit.o-ran-sc.org/r/sim/e2-interface"
# Alternative repository (if first fails)
git clone https://github.com/o-ran-sc/sim-e2-interface.git sim-e2
```

### 2. Build E2 Simulator

```bash
cd e2-interface/e2sim
# or cd sim-e2/e2sim

# Create build directory
mkdir build
cd build

# Configure and build
cmake ..
make -j$(nproc)
```

### 3. Fix Code Warnings (If Encountered)

During the build process, you might encounter format specifier warnings. Fix them as follows:

```cpp
// Change format specifiers for proper data types:
// %d to %ld for long int
// %d to %zu for size_t  
// %d to %zd for ssize_t

// Example fix:
fprintf(stderr, "encoded is %ld\n", er.encoded);  // Changed from %d to %ld
```

### 4. Clean and Rebuild (If Fixes Applied)

```bash
make clean
cmake ..
make -j$(nproc)
```

### 5. Verify Build Output

```bash
# Check for shared library
ls -lh | grep .so
# Should see: libe2sim_shared.so
```

## Near-RT RIC Platform Deployment

### 1. Install Kubernetes and Helm

```bash
cd ric-dep/bin
./install_k8s_and_helm.sh
```

### 2. Deploy RIC Platform Components

```bash
# Navigate to deployment directory
cd ric-dep

# Update Helm repositories
helm repo update

# Install RIC platform
helm install ricplt deployment/ric-platform -n ricplt --create-namespace
```

## Docker Image Build

### 1. Build E2 Simulator Docker Image

```bash
cd e2-interface/e2sim  # or sim-e2/e2sim

# Build Docker image
docker build -f e2sm_examples/kmp_e2sm/Dockerfile -t e2simul:0.0.2 .
```

**Note:** If you encounter the error `fatal: destination path 'asn1c' already exists`, run:

```bash
rm -rf asn1c && git clone https://github.com/velichkov/asn1c.git asn1c
```

### 2. Load Image to Kubernetes Cluster

```bash
# For kind cluster
kind load docker-image e2simul:0.0.2 --name demo

# For minikube
minikube image load e2simul:0.0.2
```

## Kubernetes Deployment

### 1. Deploy E2 Simulator

```bash
# Install/upgrade e2sim using Helm
helm upgrade --install e2sim ./helm -n ricplt
```

### 2. Check Initial Pod Status

```bash
kubectl get pods -n ricplt
```

**Expected Output:**
```
NAME                                                        READY   STATUS              RESTARTS      AGE
deployment-ricplt-a1mediator-78f79cbb6b-6gxbz               1/1     Running             0             32h
deployment-ricplt-alarmmanager-5b49476676-xw2lh             1/1     Running             0             32h
deployment-ricplt-e2term-alpha-f8f7d7855-w4xgz              1/1     Running             0             32h
...
e2sim-67b7bcb56c-btfx5                                      0/1     RunContainerError   2 (5s ago)    79s
```

## Helm Deployment

### 1. Verify Helm Installation

```bash
helm list -n ricplt
```

**Expected Output:**
```
NAME             NAMESPACE REVISION UPDATED                                STATUS   CHART               APP VERSION
chartmuseum      ricplt    1        2025-08-20 17:18:03.796413769 +0530 IST deployed chartmuseum-3.10.4  0.16.3     
e2sim            ricplt    3        2025-08-21 02:52:24.104238151 +0530 IST deployed e2sim-3.0.0         1.0        
ricplt           ricplt    1        2025-08-20 17:18:03.796413769 +0530 IST deployed ric-platform-6.0.0  1.0
```

### 2. Deploy xApp (KPM Basic xApp)

```bash
# Navigate to xApp directory
cd e2-interface/e2sim/e2sm_examples/kmp_e2sm/build/src/kmp

# Deploy xApp
helm install kmp-basic-xapp ./helm -n ricxapp --create-namespace
```

## Troubleshooting

### Issue 1: Pod Container Error - Image Pull Problem

**Problem:**
```bash
kubectl logs e2sim-67b7bcb56c-btfx5 -n ricplt
# Output: Error from server (BadRequest): container "e2sim" in pod "e2sim-67b7bcb56c-btfx5" is waiting to start: image can't be pulled
```

**Solution:**
```bash
# Load Docker image to cluster
kind load docker-image e2simul:0.0.2 --name demo
```

### Issue 2: Port-Forwarding Failed

**Problem:**
```bash
kubectl port-forward deployment/ricplt-e2term-alpha 36421:36421 -n ricplt
# Error: deployments.apps "ricplt-e2term-alpha" not found
```

**Solution:**
```bash
# Check correct deployment name
kubectl get deployments -n ricplt

# Use correct name
kubectl port-forward deployment/deployment-ricplt-e2term-alpha 36421:36421 -n ricplt
```

### Issue 3: SCTP Connection Refused

**Problem:**
```bash
# E2 simulator logs show:
[e2sim_sctp.cpp:187] [INFO] [SCTP] Connecting to server at 127.0.0.1:36421 ...
connect: Connection refused
```

**Solution:**
```bash
# Check if port is already in use
lsof -i :36421

# Kill process using the port
kill -9 <PID>

# Retry port-forwarding
kubectl port-forward deployment/deployment-ricplt-e2term-alpha 36421:36421 -n ricplt
```

### Issue 4: Missing Shared Library

**Problem:**
```bash
./kmp_sim: error while loading shared libraries: libe2sim_shared.so: cannot open shared object file: No such file or directory
```

**Solution:**
```bash
# Ensure library is built and available
cd e2sim/build
ls -la | grep .so

# If missing, rebuild
make clean
cmake ..
make -j$(nproc)
```

### Issue 5: SubMgr Subscription Failed

**Problem:**
```bash
# API call returns: 400 Bad Request: "parsing subscriptionParams body from \"\" failed"
```

**Solution:**
Use correct JSON payload:
```json
{
  "Meid": "gnb_734_373_16b8cef1",
  "RANFunctionID": 0,
  "SubscriptionName": "kmp-demo",
  "ClientEndpoint": { "Host": "kmp-basic-xapp.ricxapp", "Port": 80, "HTTP": true },
  "E2SubscriptionDirectives": { "E2TimeoutMs": 2000, "E2RetryCount": 2 },
  "SubscriptionDetails": [
    {
      "RANFunctionID": 0,
      "EventTriggers": "AQID",
      "ActionToBeSetupList": [
        {
          "ActionID": 1,
          "ActionType": "report",
          "SubsequentAction": { "SubsequentActionType": "continue", "TimeToWait": "w10ms" }
        }
      ]
    }
  ]
}
```

## Final Status and Verification

### 1. Check All Pods Status

```bash
kubectl get pods -A -o wide
```

**RIC Platform Pods (ricplt namespace):**
```
NAME                                                        READY   STATUS    RESTARTS         AGE
chartmuseum-6c5bcf5cb5-mn22l                                1/1     Running   0                9h
deployment-ricplt-a1mediator-78f79cbb6b-6gxbz               1/1     Running   0                2d4h
deployment-ricplt-alarmmanager-5b49476676-xw2lh             1/1     Running   0                2d4h
deployment-ricplt-appmgr-5564b65869-4vxxt                   1/1     Running   0                2d4h
deployment-ricplt-e2mgr-9b6b8f99f-njh62                     1/1     Running   0                2d4h
deployment-ricplt-e2term-alpha-f8f7d7855-w4xgz              1/1     Running   0                2d4h
deployment-ricplt-o1mediator-bf4fb5758-z9kkk                1/1     Running   0                2d4h
deployment-ricplt-rtmgr-657457c4bb-kl6vx                    1/1     Running   5 (2d4h ago)     2d4h
deployment-ricplt-submgr-858956fbdc-fhdcr                   1/1     Running   0                2d4h
deployment-ricplt-vespamgr-848f7bb874-c5k68                 1/1     Running   0                2d4h
e2sim-67b7bcb56c-btfx5                                      0/1     RunContainerError   3 (12s ago)   104s
```

### 2. Check All Services

```bash
kubectl get svc -A -o wide
```

**E2Term Related Services:**
```
NAME                                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
service-ricplt-e2term-prometheus-alpha      ClusterIP   10.96.245.191   <none>        8088/TCP                        2d4h
service-ricplt-e2term-rmr-alpha             ClusterIP   10.96.21.183    <none>        4561/TCP,38000/TCP              2d4h
service-ricplt-e2term-sctp-alpha            NodePort    10.96.171.43    <none>        36422:32222/SCTP                2d4h
```

### 3. Verify Component Versions

```bash
# Check SubMgr version
kubectl -n ricplt get deploy deployment-ricplt-submgr -o jsonpath='{.spec.template.spec.containers[0].image}{"\n"}'
# Output: nexus3.o-ran-sc.org:10002/o-ran-sc/ric-plt-submgr:0.10.2
```

### 4. Verify E2 Setup

```bash
# Check E2 setup logs
kubectl -n ricplt logs deploy/deployment-ricplt-e2mgr | grep -m1 E2_SETUP_REQUEST -A2
```

## API Testing

### 1. Port-Forward SubMgr HTTP Port

```bash
kubectl -n ricplt port-forward deploy/deployment-ricplt-submgr 18088:8088 >/dev/null 2>&1 &
```

### 2. Test SubMgr Subscriptions

```bash
# List current subscriptions
kubectl -n ricplt exec -it netshoot -- curl -s http://service-ricplt-submgr-http.ricplt:8088/ric/v1/subscriptions
```

### 3. Test OpenAPI Paths

```bash
for p in /swagger/doc.json /v3/api-docs /openapi.json /swagger.json /api-docs; do
  echo "== $p =="
  curl -sf "http://127.0.0.1:18088$p" && break
done
```

### 4. Create Subscription via API

```bash
curl -X POST http://127.0.0.1:18088/ric/v1/subscriptions \
  -H "Content-Type: application/json" \
  -d '{
    "Meid": "gnb_734_373_16b8cef1",
    "RANFunctionID": 0,
    "SubscriptionName": "kmp-demo",
    "ClientEndpoint": { "Host": "kmp-basic-xapp.ricxapp", "Port": 80, "HTTP": true },
    "E2SubscriptionDirectives": { "E2TimeoutMs": 2000, "E2RetryCount": 2 },
    "SubscriptionDetails": [
      {
        "RANFunctionID": 0,
        "EventTriggers": "AQID",
        "ActionToBeSetupList": [
          {
            "ActionID": 1,
            "ActionType": "report",
            "SubsequentAction": { "SubsequentActionType": "continue", "TimeToWait": "w10ms" }
          }
        ]
      }
    ]
  }'
```

## Key Components Deployed

### Core Platform Components
- **E2Term (Alpha)**: E2 interface termination point
- **E2Mgr**: E2 connection management
- **SubMgr**: Subscription management
- **AppMgr**: xApp lifecycle management
- **RTMgr**: Routing management
- **A1Mediator**: A1 interface handling
- **AlarmManager**: Alarm management
- **VespaMgr**: VESPA event management
- **O1Mediator**: O1 interface handling

### xApps
- **KMP Basic xApp**: Key Performance Monitoring application

### E2 Simulator
- **E2Sim**: Simulates RAN nodes for testing

## Service Selectors and Labels

### E2Term Services Configuration
- **Labels**: `app=ricplt-e2term-alpha`
- **Service Selectors**: `app=ricplt-e2term-alpha,release=r4-e2term`
- **Ports**: 
  - SCTP: 36422
  - Prometheus: 8088
  - RMR: 4561, 38000

## Lessons Learned

1. **Image Management**: Ensure Docker images are properly loaded into the Kubernetes cluster
2. **Port Conflicts**: Check for port conflicts before port-forwarding
3. **API Payloads**: Use correct JSON structure for API calls
4. **Build Dependencies**: Install all required development packages before building
5. **Format Specifiers**: Pay attention to compiler warnings about data type mismatches

## Outstanding Issues

1. **E2Sim Pod Status**: The e2sim pod continues to show `RunContainerError` status, indicating potential image or configuration issues
2. **SCTP Connectivity**: Some SCTP connection issues may persist depending on network configuration

## Resources and References

1. [Official O-RAN SC RIC Platform Installation Guide](https://docs.o-ran-sc.org/projects/o-ran-sc-ric-plt-ric-dep/en/latest/installation-guides.html)
2. [HackMD Tutorial by abdfikih](https://hackmd.io/@abdfikih/ByaUJytwR)
3. [OpenRanGym xDevSM Tutorial](https://openrangym.com/tutorials/xdevsm-tutorial)
4. [O-RAN SC Wiki - Near-RT RIC Deployment](https://lf-o-ran-sc.atlassian.net/wiki/spaces/SIM/pages/13434969/Near-RT+RIC+Deployment)
5. [O-RAN SC GitHub - RIC Platform](https://github.com/o-ran-sc/ric-plt-ric-dep)
6. [O-RAN SC GitHub - E2 Interface Simulator](https://github.com/o-ran-sc/sim-e2-interface)

## Conclusion

This deployment demonstrates the complexity of the Near-RT RIC platform and the various integration challenges that can arise. While not all components achieved perfect running status, the exercise provided valuable insights into RIC platform architecture, Kubernetes orchestration, and E2 interface simulation. The documented issues and solutions serve as a reference for future deployments and troubleshooting efforts.